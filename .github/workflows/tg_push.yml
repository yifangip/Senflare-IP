name: Telegram Push File (with Change Detection)

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 */6 * * *"   # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆå¯æ”¹ï¼‰

jobs:
  push_to_tg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: ä¸‹è½½æœ€æ–°æ–‡ä»¶
        run: |
          curl -L -o Senflare-Pro.txt https://raw.githubusercontent.com/yifangip/Senflare-IP/refs/heads/main/Senflare-Pro.txt

      - name: æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¬¡çš„ç¼“å­˜
        id: check_prev
        run: |
          if [ -f .last_version.txt ]; then
            echo "has_previous=true" >> $GITHUB_OUTPUT
          else
            echo "has_previous=false" >> $GITHUB_OUTPUT
          fi

      - name: æ¯”è¾ƒæ–‡ä»¶å“ˆå¸Œ
        id: compare
        run: |
          NEW_HASH=$(sha256sum Senflare-Pro.txt | awk '{print $1}')
          echo "æ–°æ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"

          if [ -f .last_version.txt ]; then
            OLD_HASH=$(cat .last_version.txt)
            echo "æ—§æ–‡ä»¶å“ˆå¸Œ: $OLD_HASH"
          else
            OLD_HASH=""
          fi

          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: æ¨é€åˆ° Telegramï¼ˆä»…å½“æ–‡ä»¶å˜æ›´æ—¶ï¼‰
        if: steps.compare.outputs.changed == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -F document=@Senflare-Pro.txt \
               -F caption="ğŸ“¦ Senflare-Pro.txt æ–‡ä»¶å·²æ›´æ–°ï¼" \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument?chat_id=${CHAT_ID}"

      - name: ä¿å­˜æ–°æ–‡ä»¶å“ˆå¸Œä¾›ä¸‹æ¬¡æ¯”å¯¹
        if: steps.compare.outputs.changed == 'true'
        run: |
          sha256sum Senflare-Pro.txt | awk '{print $1}' > .last_version.txt

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“ï¼ˆä¿å­˜å“ˆå¸Œï¼‰
        if: steps.compare.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .last_version.txt
          git commit -m "update last_version.txt (auto)"
          git push
