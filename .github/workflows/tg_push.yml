name: Telegram Push Senflare IP

on:
  workflow_dispatch:     # âœ… æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 */8 * * *" # âœ… æ¯8å°æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼Œå¯æ”¹ï¼‰

jobs:
  push_to_tg:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ä¸‹è½½æœ€æ–°æ–‡ä»¶
      - name: ä¸‹è½½ Senflare-Pro.txt
        id: download
        run: |
          set -e
          curl -fL -o Senflare-Pro.txt https://raw.githubusercontent.com/yifangip/Senflare-IP/refs/heads/main/Senflare-Pro.txt

      # 3ï¸âƒ£ æ¯”è¾ƒæ–‡ä»¶å“ˆå¸Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
      - name: æ¯”è¾ƒæ–‡ä»¶å“ˆå¸Œ
        id: compare
        run: |
          set -e
          NEW_HASH=$(sha256sum Senflare-Pro.txt | awk '{print $1}')
          OLD_HASH=$(cat .last_version.txt 2>/dev/null || echo "")
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # 4ï¸âƒ£ ç”Ÿæˆæ–‡ä»¶åå’Œç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…å½“æ–‡ä»¶å˜åŒ–æ—¶ï¼‰
      - name: ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å & ç»Ÿè®¡ IP
        if: steps.compare.outputs.changed == 'true'
        id: info
        run: |
          set -e
          # ä½¿ç”¨åŒ—äº¬æ—¶é—´ (UTC+8)
          TIME_STR=$(date -d "+8 hour" '+%Y-%m-%d_%H-%M')
          READABLE_TIME=$(date -d "+8 hour" '+%Y-%m-%d %H:%M')
          NEW_NAME="${TIME_STR}_ä¼˜é€‰ip.txt"
          mv Senflare-Pro.txt "$NEW_NAME"

          # ç»Ÿè®¡ IP æ•°é‡ï¼ˆæŒ‰è¡Œæ•°ï¼‰
          IP_COUNT=$(wc -l < "$NEW_NAME" | tr -d ' ')
          echo "file_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "ip_count=$IP_COUNT" >> $GITHUB_OUTPUT
          echo "time_text=$READABLE_TIME" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ æ¨é€æ–‡ä»¶åˆ° Telegram
      - name: æ¨é€åˆ° Telegram
        if: steps.compare.outputs.changed == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          FILE_NAME="${{ steps.info.outputs.file_name }}"
          IP_COUNT="${{ steps.info.outputs.ip_count }}"
          TIME_TEXT="${{ steps.info.outputs.time_text }}"

          CAPTION=$(cat <<EOF
ğŸ“¦ *Senflare ä¼˜é€‰IPæ›´æ–°é€šçŸ¥*
ğŸ•“ æ›´æ–°æ—¶é—´ï¼š${TIME_TEXT}
ğŸ“Š IPæ•°é‡ï¼š${IP_COUNT} ä¸ª
ğŸ§¾ æ–‡ä»¶åï¼š${FILE_NAME}
EOF
          )

          curl -sS -f -F document=@"$FILE_NAME" \
               -F parse_mode="Markdown" \
               -F caption="$CAPTION" \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument?chat_id=${CHAT_ID}"

      # 6ï¸âƒ£ ä¿å­˜æ–°æ–‡ä»¶å“ˆå¸Œ
      - name: ä¿å­˜æ–‡ä»¶å“ˆå¸Œ
        if: steps.compare.outputs.changed == 'true'
        run: |
          curl -L -s https://raw.githubusercontent.com/yifangip/Senflare-IP/refs/heads/main/Senflare-Pro.txt | sha256sum | awk '{print $1}' > .last_version.txt
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .last_version.txt
          git commit -m "update last_version.txt (auto)" || true
          git push || true

      # 7ï¸âƒ£ å‡ºé”™è‡ªåŠ¨é€šçŸ¥ Telegram
      - name: å‘é€é”™è¯¯æé†’
        if: ${{ failure() }}
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -sS -f -X POST \
               -H "Content-Type: application/json" \
               -d "{\"chat_id\": \"${CHAT_ID}\", \"text\": \"âš ï¸ Senflare æ¨é€å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Actions æ—¥å¿—ã€‚\", \"disable_notification\": false}" \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"
