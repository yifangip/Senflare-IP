name: Telegram Push File

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  push_to_tg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ–‡ä»¶
        run: curl -L -o Senflare-Pro.txt https://raw.githubusercontent.com/yifangip/Senflare-IP/refs/heads/main/Senflare-Pro.txt

      - name: å¯¹æ¯”æ–‡ä»¶å“ˆå¸Œ
        id: compare
        run: |
          NEW_HASH=$(sha256sum Senflare-Pro.txt | awk '{print $1}')
          if [ -f .last_version.txt ]; then
            OLD_HASH=$(cat .last_version.txt)
          else
            OLD_HASH=""
          fi

          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "true" > .changed
          else
            echo "false" > .changed
          fi

      - name: å¤„ç†æ–‡ä»¶åå’Œç»Ÿè®¡IP
        run: |
          CHANGED=$(cat .changed)
          if [ "$CHANGED" = "true" ]; then
            TIME_STR=$(date -d "+8 hour" '+%Y-%m-%d_%H-%M')
            READABLE_TIME=$(date -d "+8 hour" '+%Y-%m-%d %H:%M')
            NEW_NAME="${TIME_STR}_ä¼˜é€‰ip.txt"
            mv Senflare-Pro.txt "$NEW_NAME"
            IP_COUNT=$(wc -l < "$NEW_NAME" | tr -d ' ')
            echo "æ¨é€æ–‡ä»¶: $NEW_NAME"
            echo "æ›´æ–°æ—¶é—´: $READABLE_TIME"
            echo "IPæ•°é‡: $IP_COUNT"

            # æ¨é€åˆ° Telegram
            curl -F document=@"$NEW_NAME" \
                 -F caption="ğŸ“¦ Senflare ä¼˜é€‰IPæ›´æ–°é€šçŸ¥
ğŸ•“ æ›´æ–°æ—¶é—´ï¼š$READABLE_TIME
ğŸ“Š IPæ•°é‡ï¼š$IP_COUNT ä¸ª
ğŸ§¾ æ–‡ä»¶åï¼š$NEW_NAME" \
                 "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendDocument?chat_id=${{ secrets.TG_CHAT_ID }}"

            # ä¿å­˜å“ˆå¸Œ
            sha256sum "$NEW_NAME" | awk '{print $1}' > .last_version.txt
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .last_version.txt
            git commit -m "update last_version.txt (auto)" || true
            git push || true
          else
            echo "æ–‡ä»¶æœªæ›´æ–°ï¼Œä¸æ¨é€"
          fi
